<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Aventurero v13 (CSP Corregido v2)</title>
    <!-- Importaci√≥n de la librer√≠a Chart.js para los gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ==========================================================================
           ESTILOS GENERALES
           ========================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        html { font-size: 100%; scroll-behavior: smooth; }
        body { background-color: #1e1e2f; color: #dcdcdc; font-family: 'Press Start 2P', cursive; display: flex; justify-content: center; align-items: flex-start; padding: 20px; }
        .main-container { width: 100%; max-width: 1200px; display: flex; gap: 20px; align-items: flex-start; }
        .sidebar { width: 280px; flex-shrink: 0; position: sticky; top: 20px; }
        .main-content { flex-grow: 1; }
        .container { border: 3px solid #4f4f6f; background-color: #2a2a40; padding: 20px; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.5); border-radius: 8px; margin-bottom: 20px; box-sizing: border-box; }
        h1, h2 { color: #ffdd57; text-align: center; border-bottom: 2px solid #4f4f6f; padding-bottom: 10px; margin-top: 0; font-size: 1.5rem; text-shadow: 2px 2px #c23616; }
        h2 { font-size: 1.2rem; }
        h3 { font-size: 1rem; color: #4a90e2; margin-top: 20px; text-align: center; }
        h4 { font-size: 0.8rem; color: #a0a0c0; margin-bottom: 10px; border-top: 1px solid #4f4f6f; padding-top: 15px; margin-top: 15px;}
        label { display: block; margin-bottom: 8px; color: #a0a0c0; font-size: 0.8rem; }
        select, input[type="number"], input[type="text"], input[type="date"], input[type="time"], textarea { width: 100%; padding: 12px; margin-bottom: 15px; background-color: #1e1e2f; color: #dcdcdc; border: 2px solid #4f4f6f; border-radius: 4px; font-family: inherit; font-size: 0.9rem; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 80px; }
        button, .nav-btn, .type-btn { width: 100%; padding: 12px; margin-bottom: 10px; color: #FFFFFF; font-weight: bold; cursor: pointer; border: none; border-radius: 4px; font-family: inherit; text-align: center; transition: all 0.1s ease-in-out; display: block; font-size: 0.8rem; }
        #register-btn, #create-mission-btn { background: linear-gradient(145deg, #4a90e2, #3a7ac8); border-bottom: 4px solid #2a5a9a; }
        #auth-btn { background-color: #4CAF50; border-bottom: 4px solid #388E3C; }
        #logout-btn { background-color: #c23616; border-bottom: 4px solid #8e240e; display: none; }
        .nav-btn { background-color: #6a4f9a; border-bottom: 4px solid #4a2f7a; }
        .nav-btn.active { background-color: #8a6fba; transform: translateY(2px); border-bottom-width: 2px;}
        button:disabled { background-color: #555; border-bottom-color: #444; color: #888; cursor: not-allowed; }
        .type-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .type-btn { background-color: #555; border-bottom: 4px solid #444; width: 50%; }
        .type-btn.active { background-color: #4a90e2; border-bottom-color: #2a5a9a; transform: translateY(2px); border-bottom-width: 2px; }
        #unit-input-container { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        #unit-check { width: auto; height: 20px; }
        .chart-container { position: relative; min-height: 300px; padding: 15px; background: #1e1e2f; border-radius: 5px; margin-top: 10px; margin-bottom: 20px; }
        .skills-panel ul, .log-panel ul, .mission-list ul { list-style: none; padding: 0; max-height: 450px; overflow-y: auto; }
        .skills-panel li { background-color: #33334f; padding: 10px 15px; margin-bottom: 8px; border-left: 5px solid #ffdd57; display: block; border-radius: 4px; }
        .skill-info-container { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; margin-bottom: 10px; }
        .skill-name { font-weight: bold; }
        .skill-meta { font-size: 0.7rem; color: #a0a0c0; text-align: right; }
        .description-item { display: flex; flex-direction: column; align-items: flex-start; gap: 15px; background-color: #33334f; padding: 15px; margin-bottom: 10px; border-left: 5px solid #ffdd57; border-radius: 4px; font-size: 0.75rem; line-height: 1.5; }
        .description-header { display: flex; align-items: center; gap: 15px; width: 100%;}
        .description-img { width: 80px; height: 80px; border-radius: 4px; flex-shrink: 0; object-fit: cover; }
        .subskill-container { width: 100%; }
        .subskill-list { list-style: none; padding: 0; }
        .subskill-list li { display: flex; flex-direction: column; align-items: flex-start; background-color: #2a2a40; padding: 12px; border-radius: 3px; margin-bottom: 8px; font-size: 0.9rem; gap: 10px; border-left: 3px solid #6a4f9a; }
        .subskill-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .subskill-actions { display: flex; gap: 5px; }
        .session-history { width: 100%; margin-top: 10px; border-top: 1px solid #4f4f6f; padding-top: 10px; font-size: 0.7rem; color: #a0a0c0; }
        .session-entry { display: flex; justify-content: space-between; flex-wrap: wrap; padding: 4px; border-radius: 2px; }
        .session-entry:nth-child(odd) { background-color: #33334f; }
        .xp-earned { color: #32ff7e; font-weight: bold; }
        .subskill-input-group { display: flex; gap: 10px; align-items: center; }
        .edit-subskill-btn, .delete-subskill-btn { border: none; color: white; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-family: inherit; font-size: 0.8rem; width: auto; flex-shrink: 0; }
        .edit-subskill-btn { background: #4a90e2; }
        .delete-subskill-btn { background: #c23616; }
        .add-subskill-btn { flex-shrink: 0; width: auto; padding: 0 15px; font-size: 1.2rem; background-color: #4CAF50; border-bottom: 4px solid #388E3C; }
        .skill-icon { margin-right: 10px; }
        .log-panel ul { max-height: 400px; }
        .log-panel li { font-size: 0.75rem; padding: 8px; border-radius: 4px; line-height: 1.5; }
        .log-panel .level-up { border-left: 3px solid #32ff7e; background-color: rgba(50, 255, 126, 0.1); }
        .error { color: #ff4757; }
        .log-entry { display: grid; grid-template-columns: auto 1fr; gap: 5px 10px; align-items: center;}
        .xp-gain { grid-column: 1 / 2; grid-row: 1 / 3; font-weight: bold; color: #32ff7e; font-size: 1rem; }
        .skill-info { grid-column: 2 / 3; font-weight: bold; }
        .activity-details { grid-column: 2/3; font-size: 0.8rem; color: #a0a0c0; }
        .evaluation { grid-column: 1 / 3; display: flex; gap: 15px; margin-top: 5px; font-size: 0.65rem; }
        .intensity.bajo { color: #1e90ff; } .intensity.medio { color: #dcdcdc; } .intensity.alto { color: #ffdd57; }
        .performance.malo { color: #ff4757; } .performance.normal { color: #dcdcdc; } .performance.bueno { color: #32ff7e; }
        .level-up .level-up-msg { text-align: center; font-size: 0.8rem; color: #ffdd57; }
        .level-progress { font-size: 0.7rem; color: #a0a0c0; margin-top: 5px; }
        #gdrive-status { text-align: center; font-size: 0.7rem; padding: 10px; color: #a0a0c0; min-height: 20px; }
        .progress-bar-bg { position: relative; background-color: #1e1e2f; border-radius: 5px; height: 18px; width: 100%; border: 1px solid #4f4f6f; overflow: hidden; }
        .progress-bar-fg { background-color: #32ff7e; height: 100%; border-radius: 5px; }
        .progress-text { position: absolute; width: 100%; text-align: center; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.65rem; color: #1e1e2f; font-weight: bold; text-shadow: 0 0 2px #dcdcdc; }
        .page-content { display: none; }
        .page-content.active { display: block; }
        #version-info { font-size: 0.65rem; color: #8a8a9e; text-align: right; margin-top: 15px; padding-top: 10px; border-top: 1px solid #4f4f6f; line-height: 1.4; }
        #ranking-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #ranking-table th, #ranking-table td { padding: 12px; border-bottom: 2px solid #4f4f6f; text-align: left; font-size: 0.8rem; }
        #ranking-table th { color: #ffdd57; font-size: 0.9rem; }
        #ranking-table .rank-pos { font-size: 1.2rem; text-align: center; }
        #ranking-table .rank-name { display: flex; align-items: center; gap: 10px; }
        #ranking-table .rank-avatar { width: 30px; height: 30px; border-radius: 50%; }
        .current-user-rank { background-color: rgba(74, 144, 226, 0.2); }
        @media (max-width: 800px) { .main-container { flex-direction: column; } .sidebar { width: 100%; position: static; } .description-header { flex-direction: column; text-align: center; } html { font-size: 100%; } }
    </style>
</head>
<body>
    <div class="main-container">
        
        <div class="sidebar">
            <div class="container">
                <h2>Navegaci√≥n</h2>
                <button class="nav-btn active" data-page="dashboard">Panel de Control</button> 
                <button class="nav-btn" data-page="entrenamiento">Entrenamiento</button>
                <button class="nav-btn" data-page="ranking" style="display: none;">Ranking</button>
                <button class="nav-btn" data-page="descripcion">Descripci√≥n</button>
            </div>
            
            <div class="container gdrive-section">
                <div id="auth-status">Inicia sesi√≥n para comenzar.</div>
                <button id="auth-btn">Iniciar Sesi√≥n con Google</button>
                <button id="logout-btn">Cerrar Sesi√≥n</button>
            </div>

             <div class="container log-panel">
                <h2>Registro</h2>
                <ul id="log-list"></ul>
                <div id="version-info">v13 (CSP Corregido v2)</div>
            </div>
        </div>

        <div class="main-content">
            
            <div id="page-dashboard" class="page-content active">
                <div class="container">
                    <h1>Panel de Control</h1>
                    <div id="dashboard-charts-container"></div>
                </div>
            </div>

            <div id="page-entrenamiento" class="page-content">
                <div class="container">
                    <h1>Panel de Aventurero</h1>
                    <div class="input-section">
                        <label for="skill-select">Habilidad General:</label>
                        <select id="skill-select" disabled></select>
                        <label for="subskill-select">Habilidad Concreta:</label>
                        <select id="subskill-select" disabled></select>
                        <div id="activity-type-container">
                            <label>Tipo de Actividad:</label>
                            <div class="type-selector">
                                <button type="button" id="temporal-type-btn" class="type-btn active">Tiempo ‚è±Ô∏è</button>
                                <button type="button" id="discrete-type-btn" class="type-btn">Unidad ‚úÖ</button>
                            </div>
                        </div>
                        <div id="time-input-container">
                            <label for="time-input">Minutos de pr√°ctica:</label>
                            <input type="number" id="time-input" min="1" placeholder="Ej: 30" disabled>
                        </div>
                        <div id="unit-input-container" style="display: none;">
                            <label for="unit-check">Actividad cumplida:</label>
                            <input type="checkbox" id="unit-check" disabled>
                        </div>
                        <label for="intensity-select">Intensidad:</label>
                        <select id="intensity-select" disabled>
                            <option value="bajo">Bajo (x0.8)</option>
                            <option value="medio" selected>Medio (x1.0)</option>
                            <option value="alto">Alto (x1.2)</option>
                        </select>
                        <label for="performance-select">Desempe√±o:</label>
                        <select id="performance-select" disabled>
                            <option value="malo">Malo (x0.7)</option>
                            <option value="normal" selected>Normal (x1.0)</option>
                            <option value="bueno">Bueno (x1.3)</option>
                        </select>
                        <button id="register-btn" disabled>Registrar XP</button>
                    </div>
                </div>
                <div class="container skills-panel">
                    <h2>Habilidades</h2>
                    <ul id="skills-list"></ul>
                </div>
            </div>

            <div id="page-ranking" class="page-content">
                <div class="container">
                    <h1>Ranking de Aventureros</h1>
                    <p style="font-size: 0.8rem; color: #a0a0c0; text-align:center; line-height: 1.5;">Compara tu progreso con el de otros aventureros. Se muestran los 20 mejores seg√∫n la experiencia total.</p>
                    <div id="ranking-container">
                        <table id="ranking-table">
                            <thead>
                                <tr>
                                    <th>Pos.</th>
                                    <th>Aventurero</th>
                                    <th>Nivel Total</th>
                                    <th>XP Total</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-body">
                                <!-- El ranking se llenar√° aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="page-descripcion" class="page-content">
                <div class="container description-content">
                    <!-- Las descripciones de habilidades se generar√°n aqu√≠ -->
                </div>
            </div>

        </div>
    </div>
    
    <script type="module">
        // ==========================================================================
        //  1. IMPORTACIONES DE FIREBASE (SDK MODULAR v9+)
        // ==========================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection, 
            query, 
            orderBy, 
            limit, 
            getDocs 
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // *** NUEVA CORRECCI√ìN CSP ***
        // Deshabilitar animaciones que pueden usar 'eval' bajo el cap√≥ en algunos entornos.
        Chart.defaults.animation = false;


        // ==========================================================================
        //  2. CONFIGURACI√ìN DE FIREBASE
        // ==========================================================================
        // Tu configuraci√≥n personal de Firebase.
        const firebaseConfig = {
            apiKey: "AIzaSyAntlbZJfFyQ7NxyY5l5dXcGo4sv4Nj310", // ¬°Este valor es p√∫blico y est√° bien que est√© aqu√≠!
            authDomain: "aventurero-ba1da.firebaseapp.com",
            projectId: "aventurero-ba1da",
            storageBucket: "aventurero-ba1da.appspot.com",
            messagingSenderId: "860168195863",
            appId: "1:860168195863:web:d3384480486cf51647f152",
            measurementId: "G-LP6HY5K8HH"
        };

        // ==========================================================================
        //  3. INICIALIZACI√ìN DE SERVICIOS DE FIREBASE
        // ==========================================================================
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // ==========================================================================
        //  4. REFERENCIAS AL DOM
        // ==========================================================================
        const authBtn = document.getElementById('auth-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authStatus = document.getElementById('auth-status');
        const allInputs = document.querySelectorAll('.input-section select, .input-section input, .input-section button, .description-item button, .description-item input');
        const navRankingBtn = document.querySelector('.nav-btn[data-page="ranking"]');
        const rankingBody = document.getElementById('ranking-body');
        const registerBtn = document.getElementById('register-btn');
        const temporalBtn = document.getElementById('temporal-type-btn');
        const discreteBtn = document.getElementById('discrete-type-btn');
        const timeInputContainer = document.getElementById('time-input-container');
        const unitInputContainer = document.getElementById('unit-input-container');
        const navButtons = document.querySelectorAll('.nav-btn');
        const pages = document.querySelectorAll('.page-content');

        // ==========================================================================
        //  5. ESTADO Y CONSTANTES DE LA APP
        // ==========================================================================
        let skills = {};
        let chartInstances = {};
        let currentUser = null;
        
        const initialSkillsData = {
            'Avance (Formaci√≥n)': { xp: 0, level: 1, icon: '‚öîÔ∏è', subSkills: {}, img: 'https://placehold.co/80x80/c23616/FFFFFF?text=‚öîÔ∏è', category: 'combate', description: 'Todo lo que impulsa tu carrera.' },
            'Fuerza (Salud corporal)': { xp: 0, level: 1, icon: 'üí™', subSkills: {}, img: 'https://placehold.co/80x80/e84118/FFFFFF?text=üí™', category: 'combate', description: 'Entrenamiento de fuerza, calistenia.' },
            'Defensa (Finanzas)': { xp: 0, level: 1, icon: 'üõ°Ô∏è', subSkills: {}, img: 'https://placehold.co/80x80/4cd137/FFFFFF?text=üõ°Ô∏è', category: 'combate', description: 'Ahorrar, invertir, presupuestar.' },
            'Constituci√≥n (Resistencia)': { xp: 0, level: 1, icon: '‚ù§Ô∏è', subSkills: {}, img: 'https://placehold.co/80x80/ff4757/FFFFFF?text=‚ù§Ô∏è', category: 'combate', description: 'Dormir bien, hidrataci√≥n, chequeos.' },
            'Agilidad (Salud corporal)': { xp: 0, level: 1, icon: 'üèÉ', subSkills: {}, img: 'https://placehold.co/80x80/1e90ff/FFFFFF?text=üèÉ', category: 'combate', description: 'Cardio y Flexibilidad.' },
            'Magia (Habilidades Sociales)': { xp: 0, level: 1, icon: '‚ú®', subSkills: {}, img: 'https://placehold.co/80x80/8c7ae6/FFFFFF?text=‚ú®', category: 'combate', description: 'Comunicaci√≥n, empat√≠a, negociaci√≥n.' },
            'Espiritual (Salud Mental)': { xp: 0, level: 1, icon: 'üßò', subSkills: {}, img: 'https://placehold.co/80x80/718093/FFFFFF?text=üßò', category: 'autocuidado', description: 'Meditar, Mindfulness, diario.' },
            'Nutrici√≥n (Salud corporal)': { xp: 0, level: 1, icon: 'üåø', subSkills: {}, img: 'https://placehold.co/80x80/27ae60/FFFFFF?text=üåø', category: 'autocuidado', description: 'Planificar comidas, aprender de macros.' },
            'Cocina (Pr√°ctica)': { xp: 0, level: 1, icon: 'üç≥', subSkills: {}, img: 'https://placehold.co/80x80/fbc531/FFFFFF?text=üç≥', category: 'autocuidado', description: 'Preparar comidas, nuevas recetas.' },
            'Hobbies y Relajaci√≥n': { xp: 0, level: 1, icon: 'üåå', subSkills: {}, img: 'https://placehold.co/80x80/3498db/FFFFFF?text=üåå', category: 'autocuidado', description: 'Pasatiempos, leer ficci√≥n, pintar.' },
            'Estudio Profundo': { xp: 0, level: 1, icon: 'üìö', subSkills: {}, img: 'https://placehold.co/80x80/9b59b6/FFFFFF?text=üìö', category: 'artesania', description: 'Aprender una habilidad compleja.' },
            'Creaci√≥n (Proyectos)': { xp: 0, level: 1, icon: 'üé®', subSkills: {}, img: 'https://placehold.co/80x80/e74c3c/FFFFFF?text=üé®', category: 'artesania', description: 'Escribir, dibujar, componer m√∫sica.' },
            'Construcci√≥n (Organizaci√≥n)': { xp: 0, level: 1, icon: 'üè°', subSkills: {}, img: 'https://placehold.co/80x80/f39c12/FFFFFF?text=üè°', category: 'artesania', description: 'Ordenar tu casa, optimizar espacio.'},
            'Grabaci√≥n de Fuego (Disciplina)': { xp: 0, level: 1, icon: 'üî•', subSkills: {}, img: 'https://placehold.co/80x80/d35400/FFFFFF?text=üî•', category: 'artesania', description: 'Construir y mantener la rutina.' }
        };
        const XP_PER_15_MINS = 100;
        const XP_PER_UNIT = 150;
        const INTENSITY_MULTIPLIERS = { bajo: 0.8, medio: 1.0, alto: 1.2 };
        const PERFORMANCE_MULTIPLIERS = { malo: 0.7, normal: 1.0, bueno: 1.3 };

        // ==========================================================================
        //  6. L√ìGICA PRINCIPAL DE LA APP
        // ==========================================================================

        // --- L√ìGICA DE AUTENTICACI√ìN ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                authStatus.innerHTML = `Conectado como:<br><strong style="font-size:0.7rem;">${user.displayName}</strong>`;
                authBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                if (navRankingBtn) navRankingBtn.style.display = 'block';
                await loadUserData(user);
                // Habilitar controles despu√©s de cargar datos
                document.querySelectorAll('.input-section select, .input-section input, .input-section button, .description-item button, .description-item input').forEach(el => el.disabled = false);
            } else {
                currentUser = null;
                authStatus.textContent = 'Inicia sesi√≥n para comenzar.';
                authBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                if (navRankingBtn) navRankingBtn.style.display = 'none';
                resetLocalData();
                // Deshabilitar controles si no hay sesi√≥n
                 document.querySelectorAll('.input-section select, .input-section input, .input-section button, .description-item button, .description-item input').forEach(el => el.disabled = true);
            }
        });

        authBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => {
                console.error("Error de autenticaci√≥n:", error);
                addLogEntry(`<span class="error">Error de autenticaci√≥n: ${error.code}</span>`);
            });
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- L√ìGICA DE DATOS (LECTURA/ESCRITURA EN FIRESTORE) ---
        async function loadUserData(user) {
            addLogEntry('Cargando progreso desde la nube...');
            const userDocRef = doc(db, 'users', user.uid);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists() && docSnap.data().skills) {
                    skills = docSnap.data().skills;
                    // Sincroniza habilidades: si se a√±ade una nueva habilidad en el c√≥digo, se le a√±ade al usuario.
                    for (const skillName in initialSkillsData) {
                        if (!skills[skillName]) {
                            skills[skillName] = JSON.parse(JSON.stringify(initialSkillsData[skillName]));
                        }
                    }
                    addLogEntry('üìÇ Progreso cargado.');
                } else {
                    addLogEntry('Bienvenido, nuevo aventurero! Creando tu perfil...');
                    skills = JSON.parse(JSON.stringify(initialSkillsData));
                    await saveUserData(user, true);
                }
            } catch (error) {
                console.error("Error al cargar datos:", error);
                addLogEntry(`<span class="error">Error al cargar datos. Reintentando...</span>`);
                skills = JSON.parse(JSON.stringify(initialSkillsData)); // Fallback
            }
            updateAllUI();
        }

        async function saveUserData(user, isNewUser = false) {
            if (!user) return;
            const userDocRef = doc(db, 'users', user.uid);
            const totalXP = Object.values(skills).reduce((acc, skill) => acc + (skill.xp || 0), 0);
            const totalLevel = Object.values(skills).reduce((acc, skill) => acc + (skill.level || 1), 0);
            const dataToSave = { 
                skills, 
                displayName: user.displayName, 
                photoURL: user.photoURL, 
                lastUpdate: new Date().toISOString(), 
                totalXP, 
                totalLevel 
            };
            try {
                await setDoc(userDocRef, dataToSave, { merge: !isNewUser });
            } catch (error) {
                console.error("Error al guardar datos:", error);
                addLogEntry(`<span class="error">Error al guardar el progreso.</span>`);
            }
        }
        
        // --- FUNCIONES DE RENDERIZADO Y UI ---
        async function renderRanking() {
            if (!rankingBody) return;
            rankingBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Cargando ranking...</td></tr>';
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("totalXP", "desc"), limit(20));
                const querySnapshot = await getDocs(q);
                
                rankingBody.innerHTML = ''; 
                let rank = 1;
                querySnapshot.forEach((docSnap) => {
                    const userData = docSnap.data();
                    const row = document.createElement('tr');
                    if(currentUser && docSnap.id === currentUser.uid) row.classList.add('current-user-rank');
                    row.innerHTML = `
                        <td class="rank-pos">${rank}</td>
                        <td class="rank-name">
                            <img src="${userData.photoURL || 'https://placehold.co/30x30/FFFFFF/000000?text=?'}" alt="avatar" class="rank-avatar">
                            ${userData.displayName}
                        </td>
                        <td>${userData.totalLevel || 0}</td>
                        <td>${(userData.totalXP || 0).toLocaleString()} XP</td>`;
                    rankingBody.appendChild(row);
                    rank++;
                });
                if (querySnapshot.empty) {
                    rankingBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">A√∫n no hay aventureros en el ranking. ¬°S√© el primero!</td></tr>';
                }
            } catch (error) {
                console.error("Error al renderizar el ranking:", error);
                rankingBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: #ff4757;">No se pudo cargar el ranking.</td></tr>';
            }
        }
        
        function getXpForLevel(level) { return Math.pow(level, 2) * 1000; }
        function getLevelFromXp(xp) { if (xp < getXpForLevel(1)) return 1; return Math.min(Math.floor(Math.sqrt(xp / 1000)) + 1, 200); }
        function calculateSkillProgress(skill) { 
            const currentLevelXp = getXpForLevel(skill.level - 1);
            const nextLevelXp = getXpForLevel(skill.level);
            const xpInCurrentLevel = skill.xp - currentLevelXp;
            const xpNeededForLevel = nextLevelXp - currentLevelXp;
            return { progressPercentage: xpNeededForLevel > 0 ? (xpInCurrentLevel / xpNeededForLevel) * 100 : 0 };
        }

        function renderDashboardCharts() {
            const container = document.getElementById('dashboard-charts-container');
            if (!container || !skills || Object.keys(skills).length === 0) return;
            container.innerHTML = '';
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};
            const CATEGORIES = {
                combate: { name: 'Habilidades de "Combate"', color: '#e84118', bgColor: 'rgba(232, 65, 24, 0.2)' },
                autocuidado: { name: 'Habilidades de "Autocuidado"', color: '#4cd137', bgColor: 'rgba(76, 209, 55, 0.2)' },
                artesania: { name: 'Habilidades de "Artesan√≠a"', color: '#9b59b6', bgColor: 'rgba(155, 89, 182, 0.2)' }
            };
            const allSkillNames = Object.keys(skills);
            const radarDatasets = Object.entries(CATEGORIES).map(([catId, catData]) => ({ 
                label: catData.name, 
                data: allSkillNames.map(name => skills[name].category === catId ? skills[name].level : 0), 
                fill: true, 
                backgroundColor: catData.bgColor, 
                borderColor: catData.color, 
                pointBackgroundColor: catData.color 
            }));
            const radarCanvas = document.createElement('canvas');
            container.insertAdjacentHTML('beforeend', '<h3>Resumen General de Niveles</h3><div class="chart-container"></div>');
            container.lastElementChild.appendChild(radarCanvas);
            chartInstances.radar = new Chart(radarCanvas, { 
                type: 'radar', 
                data: { 
                    labels: allSkillNames.map(name => name.split(' ')[0]), 
                    datasets: radarDatasets 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            labels: { color: '#dcdcdc' } 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.r !== null) {
                                        label += `Nivel ${context.parsed.r}`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: { 
                        r: { 
                            angleLines: { color: '#4f4f6f' }, 
                            grid: { color: '#4f4f6f' }, 
                            pointLabels: { 
                                font: { size: 9 }, 
                                color: '#dcdcdc'
                            }, 
                            ticks: { 
                                color: '#1e1e2f', 
                                backdropColor: '#a0a0c0', 
                                stepSize: 1, 
                                font: { family: "'Press Start 2P', cursive" } 
                            } 
                        } 
                    } 
                } 
            });
        }

        function updateDisplay() {
            const skillsList = document.getElementById('skills-list');
            if(!skillsList) return;
            skillsList.innerHTML = '';
            if(!skills || Object.keys(skills).length === 0) return;
            Object.entries(skills).sort(([, a], [, b]) => (b.xp || 0) - (a.xp || 0)).forEach(([skillName, skill]) => {
                const li = document.createElement('li');
                const progress = calculateSkillProgress(skill);
                li.innerHTML = `
                    <div class="skill-info-container">
                        <span class="skill-name"><span class="skill-icon">${skill.icon}</span>${skillName}</span>
                        <div class="skill-meta">Lvl: ${skill.level}<br>${(skill.xp || 0).toLocaleString()} XP</div>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fg" style="width: ${progress.progressPercentage}%;"></div>
                        <div class="progress-text">${Math.round(progress.progressPercentage)}%</div>
                    </div>`;
                skillsList.appendChild(li);
            });
        }

        function populateSkillSelect() {
            const skillSelect = document.getElementById('skill-select');
            const selectedValue = skillSelect.value;
            skillSelect.innerHTML = '';
            if (!skills || Object.keys(skills).length === 0) return;
            Object.keys(skills).sort().forEach(skillName => skillSelect.add(new Option(skillName, skillName)));
            if (selectedValue) skillSelect.value = selectedValue;
            populateSubSkillSelect(skillSelect.value);
        }
        function populateSubSkillSelect(skillName) {
            const subSkillSelect = document.getElementById('subskill-select');
            const selectedValue = subSkillSelect.value;
            subSkillSelect.innerHTML = '';
            if (!skills[skillName]) return;
            const subSkills = skills[skillName].subSkills;
            if (!subSkills || Object.keys(subSkills).length === 0) {
                subSkillSelect.disabled = true;
                subSkillSelect.add(new Option('A√±ade Habilidades en "Descripci√≥n"', '', true, true));
            } else {
                subSkillSelect.disabled = false;
                Object.keys(subSkills).sort().forEach(subSkillName => subSkillSelect.add(new Option(subSkillName, subSkillName)));
                if(selectedValue) subSkillSelect.value = selectedValue;
            }
        }
        
        function addLogEntry(message, type = '') {
            const logList = document.getElementById('log-list');
            const logEntry = document.createElement('li');
            logEntry.innerHTML = message;
            if (type) logEntry.classList.add(type);
            logList.prepend(logEntry);
            while (logList.children.length > 50) logList.removeChild(logList.lastChild);
        }

        function resetLocalData() {
            skills = JSON.parse(JSON.stringify(initialSkillsData));
            const logList = document.getElementById('log-list');
            if (logList) logList.innerHTML = '';
            addLogEntry('üöÄ ¬°Bienvenido! Inicia sesi√≥n para cargar tu progreso.');
            updateAllUI();
        }
        function updateAllUI() {
            updateDisplay();
            populateSkillSelect();
            renderDescriptionPage();
            renderDashboardCharts();
        }
        function renderDescriptionPage() {
            const descriptionContainer = document.querySelector('#page-descripcion .description-content');
            if (!descriptionContainer) return;
            descriptionContainer.innerHTML = '<h1>Descripci√≥n de Habilidades</h1>';
            const categories = { combate: 'Habilidades de "Combate"', autocuidado: 'Habilidades de "Autocuidado"', artesania: 'Habilidades de "Artesan√≠a"' };
            for (const categoryId in categories) {
                const categoryTitle = document.createElement('h3');
                categoryTitle.textContent = categories[categoryId];
                descriptionContainer.appendChild(categoryTitle);
                const categoryList = document.createElement('ul'); categoryList.style.padding = '0';
                for (const skillName in skills) {
                    if (skills[skillName]?.category === categoryId) {
                        const skill = skills[skillName];
                        const item = document.createElement('li');
                        item.className = 'description-item';
                        item.setAttribute('data-skill', skillName);
                        item.innerHTML = `
                            <div class="description-header">
                                <img src="${skill.img}" alt="Icono" class="description-img">
                                <div><strong>${skillName}:</strong> ${skill.description}</div>
                            </div>
                            <div class="subskill-container">
                                <h4>Habilidades Concretas:</h4>
                                <ul class="subskill-list"></ul>
                                <div class="subskill-input-group">
                                    <input type="text" placeholder="A√±adir habilidad..." maxlength="50" ${!currentUser ? 'disabled' : ''}>
                                    <button class="add-subskill-btn" ${!currentUser ? 'disabled' : ''}>+</button>
                                </div>
                            </div>`;
                        categoryList.appendChild(item);
                    }
                }
                descriptionContainer.appendChild(categoryList);
            }
            renderAllSubSkillLists();
            addDescriptionPageListeners();
        }
        function renderAllSubSkillLists() { for (const skillName in skills) { if (skills.hasOwnProperty(skillName)) renderSubSkillList(skillName); } }
        function renderSubSkillList(skillName) {
            const listElement = document.querySelector(`.description-item[data-skill="${skillName}"] .subskill-list`);
            if (!listElement) return;
            listElement.innerHTML = '';
            const skill = skills[skillName];
            if (skill && skill.subSkills) {
                Object.entries(skill.subSkills).forEach(([subSkillName, subSkillData]) => {
                    const li = document.createElement('li');
                    let sessionsHTML = '<div class="session-history"><h5>Historial Reciente:</h5>';
                    if (subSkillData.sessions && subSkillData.sessions.length > 0) {
                        subSkillData.sessions.slice(-5).reverse().forEach(session => {
                            const dateStr = new Date(session.date).toLocaleDateString();
                            const activityTypeIcon = session.type === 'temporal' ? '‚è±Ô∏è' : '‚úÖ';
                            const activityDetail = session.type === 'temporal' ? `${session.time} min` : 'Unidad';
                            sessionsHTML += `<div class="session-entry"><span>${activityTypeIcon} ${dateStr}: ${activityDetail}</span><span class="xp-earned">+${(session.xpEarned || 0).toLocaleString()} XP</span></div>`;
                        });
                    } else { sessionsHTML += '<span>No hay sesiones registradas.</span>'; }
                    sessionsHTML += '</div>';
                    li.innerHTML = `
                        <div class="subskill-header">
                            <span>${subSkillName}</span> 
                            <div class="subskill-actions">
                                <button class="edit-subskill-btn" data-name="${subSkillName}">‚úèÔ∏è</button>
                                <button class="delete-subskill-btn" data-name="${subSkillName}">üóëÔ∏è</button>
                            </div>
                        </div>
                        ${sessionsHTML}`;
                    listElement.appendChild(li);
                });
            }
        }
        function addDescriptionPageListeners() {
            const descriptionContainer = document.querySelector('#page-descripcion .description-content');
            if (!descriptionContainer) return;
            descriptionContainer.addEventListener('click', async (e) => {
                if (!currentUser) return; // No hacer nada si no hay sesi√≥n
                const target = e.target.closest('button'); if (!target) return;
                const parentItem = target.closest('.description-item'); if (!parentItem) return;
                const skillName = parentItem.getAttribute('data-skill'); const skillData = skills[skillName];
                if (!skillData.subSkills) skillData.subSkills = {};

                if (target.classList.contains('add-subskill-btn')) { 
                    const input = parentItem.querySelector('input[type="text"]'); 
                    const value = input.value.trim(); 
                    if (value && !skillData.subSkills.hasOwnProperty(value)) { 
                        skillData.subSkills[value] = { xp: 0, sessions: [] }; 
                        await saveUserData(currentUser); 
                        renderSubSkillList(skillName); 
                        populateSubSkillSelect(document.getElementById('skill-select').value); 
                        input.value = ''; 
                    } 
                }
                else if (target.classList.contains('edit-subskill-btn')) { 
                    const oldName = target.getAttribute('data-name'); 
                    const newName = prompt('Nuevo nombre para la habilidad:', oldName); 
                    if (newName && newName.trim() !== '' && newName !== oldName && !skillData.subSkills.hasOwnProperty(newName)) { 
                        Object.defineProperty(skillData.subSkills, newName, Object.getOwnPropertyDescriptor(skillData.subSkills, oldName)); 
                        delete skillData.subSkills[oldName]; 
                        await saveUserData(currentUser); 
                        renderSubSkillList(skillName); 
                        populateSubSkillSelect(document.getElementById('skill-select').value); 
                        addLogEntry(`‚úîÔ∏è "${oldName}" renombrada a "${newName}".`); 
                    } 
                }
                else if (target.classList.contains('delete-subskill-btn')) { 
                    const subSkillNameToDelete = target.getAttribute('data-name');
                    if (window.confirm(`¬øSeguro que quieres borrar "${subSkillNameToDelete}"? Esta acci√≥n no se puede deshacer.`)) {
                         delete skillData.subSkills[subSkillNameToDelete]; 
                         await saveUserData(currentUser); 
                         renderSubSkillList(skillName); 
                         populateSubSkillSelect(document.getElementById('skill-select').value); 
                         addLogEntry(`üóëÔ∏è Habilidad concreta "${subSkillNameToDelete}" eliminada.`);
                    }
                }
            });
        }
        
        // --- EVENT LISTENERS GENERALES ---
        document.getElementById('skill-select').addEventListener('change', (e) => populateSubSkillSelect(e.target.value));
        temporalBtn.addEventListener('click', () => { temporalBtn.classList.add('active'); discreteBtn.classList.remove('active'); timeInputContainer.style.display = 'block'; unitInputContainer.style.display = 'none'; });
        discreteBtn.addEventListener('click', () => { discreteBtn.classList.add('active'); temporalBtn.classList.remove('active'); timeInputContainer.style.display = 'none'; unitInputContainer.style.display = 'block'; });

        registerBtn.addEventListener('click', async () => {
            try {
                const selectedSkill = document.getElementById('skill-select').value;
                const selectedSubSkill = document.getElementById('subskill-select').value;
                const activityType = temporalBtn.classList.contains('active') ? 'temporal' : 'discrete';
                if (!selectedSkill || document.getElementById('subskill-select').disabled || !selectedSubSkill) {
                    throw new Error('Selecciona una habilidad general y concreta v√°lidas.');
                }
                const skillData = skills[selectedSkill]; const subSkillData = skillData.subSkills[selectedSubSkill]; const oldLevel = skillData.level;
                let timeSpent;
                if (activityType === 'temporal') { 
                    timeSpent = parseInt(document.getElementById('time-input').value, 10); 
                    if (isNaN(timeSpent) || timeSpent <= 0) throw new Error('Ingresa un tiempo v√°lido.'); 
                } else { 
                    if (!document.getElementById('unit-check').checked) throw new Error('Marca la actividad como completada.'); 
                }
                const intensity = document.getElementById('intensity-select').value;
                const performance = document.getElementById('performance-select').value;
                const baseXp = activityType === 'temporal' ? Math.floor((timeSpent / 15) * XP_PER_15_MINS) : XP_PER_UNIT;
                const xpGained = Math.floor(baseXp * INTENSITY_MULTIPLIERS[intensity] * PERFORMANCE_MULTIPLIERS[performance]);
                
                if (!subSkillData.sessions) subSkillData.sessions = [];
                subSkillData.xp = (subSkillData.xp || 0) + xpGained;
                skillData.xp = (skillData.xp || 0) + xpGained;
                subSkillData.sessions.push({ date: new Date().toISOString(), type: activityType, time: activityType === 'temporal' ? timeSpent : null, intensity, performance, xpEarned: xpGained });
                skillData.level = getLevelFromXp(skillData.xp);
                
                addLogEntry(`<div class="log-entry"><span class="xp-gain">+${xpGained.toLocaleString()}</span><span class="skill-info">${skillData.icon} ${selectedSubSkill}</span><span class="activity-details">(${selectedSkill})</span></div>`, skillData.level > oldLevel ? 'level-up' : '');
                if (skillData.level > oldLevel) {
                    addLogEntry(`<div class="level-up"><span class="level-up-msg">üéâ ¬°Nivel ${skillData.level} en ${selectedSkill}!</span></div>`, 'level-up');
                }
                
                document.getElementById('time-input').value = ''; 
                document.getElementById('unit-check').checked = false;
                await saveUserData(currentUser);
                updateAllUI();
            } catch (error) { 
                addLogEntry(`<span class="error">‚úó ${error.message}</span>`); 
            }
        });
        
        function switchPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            const newPage = document.getElementById(`page-${pageId}`);
            if (newPage) newPage.classList.add('active');
            
            navButtons.forEach(btn => btn.classList.remove('active'));
            const newButton = document.querySelector(`.nav-btn[data-page="${pageId}"]`);
            if (newButton) newButton.classList.add('active');
            
            if (pageId === 'ranking' && currentUser) {
                renderRanking();
            }
        }

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const pageId = button.getAttribute('data-page');
                switchPage(pageId);
            });
        });

        // --- INICIALIZACI√ìN AL CARGAR LA P√ÅGINA ---
        window.addEventListener('DOMContentLoaded', () => {
             resetLocalData();
        });
    </script>
</body>
</html>
